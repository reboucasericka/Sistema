
@model Sistema.Models.Admin.AdminReportsViewModel
@{
    ViewData["Title"] = "Relatórios Administrativos";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="content-header">
    <div class="row mb-2">
        <div class="col-sm-6">
            <h1 class="m-0"><i class="fas fa-chart-line me-2"></i>Relatórios Administrativos</h1>
        </div>
        
    </div>
</div>

<section class="content">
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm border-start-success">
                <div class="card-body">
                    <h6 class="text-muted">Entradas</h6>
                    <h3 class="fw-bold text-success">€@Model.TotalEntradas.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm border-start-danger">
                <div class="card-body">
                    <h6 class="text-muted">Saídas</h6>
                    <h3 class="fw-bold text-danger">€@Model.TotalSaidas.ToString("N2")</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card shadow-sm border-start-primary">
                <div class="card-body">
                    <h6 class="text-muted">Saldo Atual</h6>
                    <h3 class="fw-bold text-primary">€@Model.SaldoAtual.ToString("N2")</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico Financeiro -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-chart-bar me-2"></i>Fluxo Financeiro (7 dias)</h5>
        </div>
        <div class="card-body">
            <canvas id="cashFlowChart" height="100"></canvas>
        </div>
    </div>

    <!-- Serviços Mais Vendidos -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-spa me-2"></i>Serviços Mais Realizados</h5>
        </div>
        <div class="card-body">
            <ul class="list-group">
                @foreach (var s in Model.ServicosMaisVendidos)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        @s.Label
                        <span class="badge bg-primary rounded-pill">@s.Value</span>
                    </li>
                }
            </ul>
        </div>
    </div>

    <!-- Relatório de Clientes -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="m-0"><i class="fas fa-users me-2"></i>Clientes</h5>
        </div>
        <div class="card-body">
            <p><strong>Total de Clientes:</strong> @Model.ClientesTotais</p>
            <p><strong>Novos no último mês:</strong> @Model.ClientesNovos</p>
        </div>
    </div>

    <!-- Botões de Exportação -->
    <div class="text-end mt-4">
        <a asp-action="ExportToPdf" class="btn btn-outline-danger me-2">
            <i class="fas fa-file-pdf me-2"></i>Exportar Relatório PDF
        </a>
        <a asp-action="ExportToExcel" class="btn btn-outline-success">
            <i class="fas fa-file-excel me-2"></i>Exportar Excel
        </a>
    </div>

</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const ctx = document.getElementById("cashFlowChart").getContext("2d");
            const response = await fetch("/Admin/AdminReports/GetCashFlowChartData");
            const data = await response.json();

            const labels = data.map(x => x.Day);
            const entradas = data.map(x => x.Entradas);
            const saidas = data.map(x => x.Saidas);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Entradas (€)',
                            data: entradas,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)'
                        },
                        {
                            label: 'Saídas (€)',
                            data: saidas,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 50 }
                        }
                    }
                }
            });
        });
    </script>
}