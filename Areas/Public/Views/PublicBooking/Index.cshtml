@model IEnumerable<Sistema.Data.Entities.Service>

@{
    ViewData["Title"] = "Agendamento Online";
}

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar de Filtros -->
        <div class="col-md-3 bg-light p-4">
            <h5 class="mb-4">Filtros</h5>
            
            <!-- Data -->
            <div class="mb-4">
                <label class="form-label fw-bold">Quando deseja agendar</label>
                <input type="date" class="form-control" id="bookingDate" value="@DateTime.Today.ToString("yyyy-MM-dd")">
            </div>

            <!-- Preço -->
            <div class="mb-4">
                <label class="form-label fw-bold">Preço</label>
                <div class="d-flex justify-content-between">
                    <span>€0</span>
                    <span>€200+</span>
                </div>
                <input type="range" class="form-range" min="0" max="200" value="100" id="priceRange">
            </div>

            <!-- Serviços -->
            <div class="mb-4">
                <label class="form-label fw-bold">Serviços</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="discountOnly">
                    <label class="form-check-label" for="discountOnly">
                        Somente com desconto %
                    </label>
                </div>
            </div>

            <!-- Categorias -->
            <div class="mb-4">
                <label class="form-label fw-bold">Categorias</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="barbearia">
                    <label class="form-check-label" for="barbearia">Barbearia</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="cabelos">
                    <label class="form-check-label" for="cabelos">Cabelos</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="depilacao">
                    <label class="form-check-label" for="depilacao">Depilação</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="maquiagem">
                    <label class="form-check-label" for="maquiagem">Maquiagem</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="massagem">
                    <label class="form-check-label" for="massagem">Massagem e Estética</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="podologia">
                    <label class="form-check-label" for="podologia">Podologia</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="sobrancelhas">
                    <label class="form-check-label" for="sobrancelhas">Sobrancelhas</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="unhas">
                    <label class="form-check-label" for="unhas">Unhas</label>
                </div>
            </div>

            <!-- Facilidades -->
            <div class="mb-4">
                <label class="form-label fw-bold">Facilidades</label>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-warning text-dark">Agendamento online</span>
                    <span class="badge bg-warning text-dark">Aceita cartão de crédito</span>
                    <span class="badge bg-warning text-dark">Acesso WiFi</span>
                    <span class="badge bg-warning text-dark">Acesso para deficientes</span>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal -->
        <div class="col-md-9 p-4">
            <!-- Header do Estabelecimento -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                <span class="fw-bold fs-3">E</span>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h3 class="mb-1">Ewellin Jordão - Estética</h3>
                            <p class="text-muted mb-1">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Rua da Beleza, 123, Centro, Lisboa
                            </p>
                            <div class="d-flex align-items-center">
                                <div class="text-warning me-2">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                </div>
                                <span class="text-muted">Avaliações (26)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Serviços -->
            <div class="services-list">
                @foreach (var service in Model)
                {
                    <div class="card mb-3 service-card" data-service-id="@service.ServiceId">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    @if (service.ImageId != Guid.Empty)
                                    {
                                        <img src="@service.ImageFullPath" alt="@service.Name" class="img-fluid rounded" style="max-height: 80px;">
                                    }
                                    else
                                    {
                                        <div class="bg-primary text-white rounded d-flex align-items-center justify-content-center" style="height: 80px;">
                                            <i class="fas fa-concierge-bell fa-2x"></i>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-6">
                                    <h5 class="mb-1">@service.Name</h5>
                                    <p class="text-muted mb-1">@service.Category?.Name</p>
                                    <p class="text-muted mb-0">@service.Duration</p>
                                    @if (!string.IsNullOrEmpty(service.Description))
                                    {
                                        <p class="small text-muted">@service.Description</p>
                                    }
                                </div>
                                <div class="col-md-2 text-center">
                                    <div class="fw-bold text-primary fs-5">@String.Format(new System.Globalization.CultureInfo("pt-PT"), "{0:C}", service.Price)</div>
                                </div>
                                <div class="col-md-2 text-center">
                                    <a asp-action="Schedule" asp-route-id="@service.ServiceId" class="btn btn-primary">
                                        <i class="fas fa-calendar-plus"></i> Agendar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Link para ver todos os serviços -->
            <div class="text-center mt-4">
                <a href="#" class="btn btn-outline-primary">
                    Ver todos os serviços <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Toggle dos serviços
            $('.service-toggle').click(function() {
                const serviceId = $(this).data('service-id');
                const details = $(this).closest('.service-card').find('.service-details');
                const icon = $(this).find('i');
                
                if (details.is(':visible')) {
                    details.slideUp();
                    icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
                } else {
                    // Carregar profissionais se ainda não foram carregados
                    if (details.find('.professionals-list').children().length === 0) {
                        loadServiceDetails(serviceId);
                    }
                    details.slideDown();
                    icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
                }
            });
        });

        function loadServiceDetails(serviceId) {
            $.ajax({
                url: '/PublicBooking/GetServiceDetails',
                type: 'GET',
                data: { serviceId: serviceId },
                success: function(response) {
                    if (response.success) {
                        displayProfessionals(serviceId, response.professionals);
                    }
                },
                error: function() {
                    console.error('Erro ao carregar detalhes do serviço');
                }
            });
        }

        function displayProfessionals(serviceId, professionals) {
            const container = $(`.service-card[data-service-id="${serviceId}"] .professionals-list`);
            let html = '';

            professionals.forEach(function(professional) {
                const recommendationsText = professional.recommendations > 0 
                    ? `${professional.recommendations} recomendações` 
                    : 'Nenhuma recomendação';

                const hasAvailableTimes = professional.availableTimes.length > 0;
                const timeButtons = hasAvailableTimes 
                    ? professional.availableTimes.map(time => 
                        `<button class="btn btn-success btn-sm me-2 mb-2 time-slot" data-time="${time}">${time}</button>`
                      ).join('')
                    : '<button class="btn btn-secondary btn-sm" disabled>HORÁRIOS INDISPONÍVEIS</button>';

                html += `
                    <div class="professional-card border rounded p-3 mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <img src="${professional.photo}" class="rounded-circle me-3" width="40" height="40" alt="${professional.name}">
                            <div>
                                <h6 class="mb-0">${professional.name}</h6>
                                <small class="text-muted">${professional.specialty}</small>
                            </div>
                            <div class="ms-auto">
                                <small class="text-muted">${recommendationsText}</small>
                            </div>
                        </div>
                        <div class="time-slots">
                            ${timeButtons}
                        </div>
                    </div>
                `;
            });

            container.html(html);

            // Adicionar evento aos botões de horário
            container.find('.time-slot').click(function() {
                const time = $(this).data('time');
                const serviceId = $(this).closest('.service-card').data('service-id');
                bookAppointment(serviceId, time);
            });
        }

        function bookAppointment(serviceId, time) {
            // Redirecionar para login se não estiver logado
            if (!@(User.Identity.IsAuthenticated.ToString().ToLower())) {
                window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                return;
            }

            // Redirecionar para página de agendamento
            window.location.href = `/Client/NewAppointment?serviceId=${serviceId}&time=${time}`;
        }
    </script>
}
